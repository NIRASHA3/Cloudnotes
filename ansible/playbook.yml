---
- name: Deploy CloudNotes Application on AWS EC2
  hosts: project_CloudNotes
  become: yes
  gather_facts: yes
  
  vars:
    app_name: "cloudnotes"
    app_user: "ubuntu"
    app_dir: "/opt/{{ app_name }}"
    docker_compose_version: "v2.24.5"
    
    # Domain configuration - Change this to your DuckDNS domain
    app_domain: "cloudnotes.duckdns.org"
    letsencrypt_email: "nirashadeshani3@gmail.com"
    
    # Docker images from your Docker Hub
    backend_image: "nirashadeshani/cloudnotes:backend"
    frontend_image: "nirashadeshani/cloudnotes:frontend"
    
    # These will be passed from Jenkins credentials
    mongodb_uri: "{{ lookup('env', 'MONGO_URI') }}"
    jwt_secret: "{{ lookup('env', 'JWT_SECRET') }}"
    google_client_id: "{{ lookup('env', 'GOOGLE_CLIENT_ID') }}"
    google_client_secret: "{{ lookup('env', 'GOOGLE_CLIENT_SECRET') }}"
    email_pass: "{{ lookup('env', 'EMAIL_PASS') }}"
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
    
    - name: Install required system packages
      apt:
        name:
          - docker.io
          - git
          - curl
          - nginx
          - certbot
          - python3-certbot-nginx
          - python3-pip
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
        update_cache: yes
    
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
    
    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        update_cache: yes
    
    - name: Install Docker Compose Plugin
      apt:
        name:
          - docker-compose-plugin
        state: present
        update_cache: yes
    
    - name: Add user to docker group
      user:
        name: "{{ app_user }}"
        groups: docker
        append: yes
    
    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
        daemon_reload: yes
    
    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'
    
    - name: Create docker-compose.yml
      template:
        src: templates/docker-compose.yml.j2
        dest: "{{ app_dir }}/docker-compose.yml"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0644'

    - name: Create Nginx site config
      template:
        src: templates/nginx-cloudnotes.conf.j2
        dest: "/etc/nginx/sites-available/cloudnotes.conf"
        owner: root
        group: root
        mode: '0644'

    - name: Enable Nginx site
      file:
        src: "/etc/nginx/sites-available/cloudnotes.conf"
        dest: "/etc/nginx/sites-enabled/cloudnotes.conf"
        state: link

    - name: Disable default Nginx site
      file:
        path: "/etc/nginx/sites-enabled/default"
        state: absent

    - name: Reload Nginx
      systemd:
        name: nginx
        state: restarted
        enabled: yes
    
    - name: Create backend environment file
      template:
        src: templates/backend.env.j2
        dest: "{{ app_dir }}/.env.backend"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0600'
    
    - name: Pull Docker images
      community.docker.docker_image:
        name: "{{ item }}"
        source: pull
        state: present
        force_source: yes
      loop:
        - "{{ backend_image }}"
        - "{{ frontend_image }}"
    
    - name: Deploy application with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        state: present
        recreate: always

    - name: Obtain/renew Let's Encrypt certificate
      command: >-
        certbot --nginx -d {{ app_domain }}
        --non-interactive --agree-tos -m {{ letsencrypt_email }} --redirect
      args:
        creates: "/etc/letsencrypt/live/{{ app_domain }}/fullchain.pem"
    
    - name: Wait for backend to be ready
      wait_for:
        port: 5000
        delay: 10
        timeout: 60
        state: started
        host: "{{ ansible_host }}"
    
    - name: Wait for frontend to be ready
      wait_for:
        port: 5173
        delay: 10
        timeout: 60
        state: started
        host: "{{ ansible_host }}"
    
    - name: Verify deployment
      uri:
        url: "https://{{ app_domain }}"
        status_code: 200
        timeout: 30
      register: deployment_check
      until: deployment_check.status == 200
      retries: 5
      delay: 10
    
    - name: Show deployment status
      debug:
        msg:
          - "CloudNotes deployment successful!"
          - "Frontend: https://{{ app_domain }}"
          - "Backend API: https://{{ app_domain }}/api"
          - "Google OAuth: https://{{ app_domain }}/api/auth/google"

